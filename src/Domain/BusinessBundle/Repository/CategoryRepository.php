<?php

namespace Domain\BusinessBundle\Repository;
use Doctrine\ORM\Internal\Hydration\IterableResult;
use Domain\BusinessBundle\Entity\Category;

/**
 * CategoryRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CategoryRepository extends \Gedmo\Tree\Entity\Repository\MaterializedPathRepository
{
    public function getAvailableCategoriesQb()
    {
        $qb = $this->createQueryBuilder('c')
            ->where('c.isActive = TRUE')
            ->orderBy('c.name');

        return $qb;
    }

    public function getAvailableParentCategoriesQb()
    {
        $qb = $this->getAvailableCategoriesQb()
            ->andWhere('c.parent IS NULL')
        ;

        return $qb;
    }

    public function getAvailableChildCategoriesQb($level = Category::CATEGORY_LEVEL_2)
    {
        $qb = $this->getAvailableCategoriesQb()
            ->andWhere('c.parent IS NOT NULL')
            ->andWhere('c.lvl = :level')
            ->setParameter('level', $level)
        ;

        return $qb;
    }

    public function getAvailableParentCategories($locale = false)
    {
        $qb = $this->getAvailableParentCategoriesQb();

        if ($locale) {
            $qb->orderBy('c.searchText' . ucfirst($locale));
        }

        return $qb->getQuery()->getResult();
    }

    public function getAvailableSubCategoriesQb($parents, $level = Category::CATEGORY_LEVEL_2)
    {
        $qb = $this->getAvailableCategoriesQb()
            ->andWhere('c.parent IN (:parents)')
            ->andWhere('c.lvl = :lvl')
            ->setParameter('parents', $parents)
            ->setParameter('lvl', $level)
        ;

        return $qb;
    }

    public function getAvailableCategories()
    {
        $qb = $this->getAvailableCategoriesQb();

        return $qb->getQuery()->getResult();
    }

    public function getAvailableSubCategories($parents, $level = Category::CATEGORY_LEVEL_2)
    {
        $qb = $this->getAvailableSubCategoriesQb($parents, $level);

        return $qb->getQuery()->getResult();
    }

    public function getAvailableCategoriesByIds($ids)
    {
        $qb = $this->getAvailableCategoriesQb()
            ->andWhere('c.id IN (:ids)')
            ->setParameter('ids', $ids)
        ;

        return $qb->getQuery()->getResult();
    }

    public function searchAutosuggest($name, string $locale)
    {
        $name    = $this->splitPhraseToPlain($name);
        $connection = $this->getEntityManager()->getConnection();

        $searchSQL = $this->getSearchSQLQuery($locale);

        $statement = $connection->prepare(
            "SELECT
                ts_headline(name, q) as data,
                name
            FROM
            (
                $searchSQL
            ) as search
            LIMIT 5"
        );

        $statement->bindValue("searchQuery", $name);
        $statement->execute();
        $results = $statement->fetchAll();

        return $results;
    }

    protected function getSearchSQLQuery(string $locale)
    {
        return 'SELECT
                c.id AS id,
                c.search_text_' . $locale . ' as name,
                q,
                ts_rank(c.search_fts_' . $locale . ', q) AS rank
            FROM
                category c,
                to_tsquery(:searchQuery) q
            WHERE
                c.search_fts_' . $locale . ' @@ q
            AND (
                c.deleted_at IS NULL
            )
            ORDER BY rank DESC, name';
    }

    protected function splitPhraseToPlain(string $phrase)
    {
        $words = explode(' ', $phrase);
        $words = array_filter($words);
        $wordParts = array_map(
            function ($item) {
                return $item . ":*";
            },
            $words
        );
        $plain = implode(' & ', $wordParts);

        return $plain;
    }

    protected function getCategoryQueryBuilder()
    {
        $queryBuilder = $this->getEntityManager()->createQueryBuilder()
            ->select('c')
            ->from('DomainBusinessBundle:Category', 'c');

        return $queryBuilder;
    }

    public function getCategoryByBusinessesIds(array $businessIdList)
    {
        $queryBuilder = $this->getCategoryQueryBuilder()
            ->join('c.businessProfiles', 'bp')
            ->where('bp.id in (:ids)')
            ->setParameter('ids', $businessIdList)
            ->orderBy('c.name')
        ;

        $results = $queryBuilder->getQuery()->getResult();

        return $results;
    }

    /**
     * Count all categories
     *
     * @return mixed
     */
    public function getAllCategoriesCount()
    {
        return $this->getEntityManager()->createQueryBuilder()
            ->select('COUNT(c.id)')
            ->from('DomainBusinessBundle:Category', 'c')
            ->getQuery()
            ->getSingleScalarResult()
        ;
    }

    public function searchSubcategoryByCategory($category, $level, $locale)
    {
        $qb = $this->getAvailableSubCategoriesQb($category, $level)
            ->orderBy('c.searchText' . ucfirst($locale));

        return $qb->getQuery()->getResult();
    }

    public function getCategoryBySlug($categorySlug, $customSlug = false)
    {
        $query = $this->getAvailableCategoriesQb()
            ->where('c.slug = :categorySlug')
            ->setParameter('categorySlug', $categorySlug)
        ;

        if ($customSlug) {
            $query->orWhere('c.slug = :customSlug')
                ->orWhere('c.slugEn = :customSlug')
                ->orWhere('c.slugEs = :customSlug')
                ->setParameter('customSlug', $customSlug)
            ;
        }

        return $query->getQuery()->getOneOrNullResult();
    }

    public function getCategoryByCustomSlug($customSlug)
    {
        $query = $this->getAvailableCategoriesQb()
            ->andWhere('c.slugEn = :customSlug OR c.slugEs = :customSlug')
            ->setParameter('customSlug', $customSlug)
        ;

        return $query->getQuery()->getOneOrNullResult();
    }

    public function getCategoriesBySlugs($categoriesSlugs)
    {
        $query = $this->getAvailableCategoriesQb()
            ->where('c.slug IN (:categoriesSlugs)')
            ->setParameter('categoriesSlugs', $categoriesSlugs)
        ;

        return $query->getQuery()->getResult();
    }

    /**
     * @return IterableResult
     */
    public function getAvailableCategoriesIterator()
    {
        $qb = $this->getAvailableCategoriesQb();

        $query = $this->getEntityManager()->createQuery($qb->getDQL());

        $iterateResult = $query->iterate();

        return $iterateResult;
    }

    /**
     * @return IterableResult
     */
    public function getAvailableParentCategoriesIterator()
    {
        $qb = $this->getAvailableParentCategoriesQb();

        $query = $this->getEntityManager()->createQuery($qb->getDQL());

        $iterateResult = $query->iterate();

        return $iterateResult;
    }

    public function getAvailableSubcategoriesByCategoryIterator($category, $level)
    {
        $qb = $this->getAvailableSubCategoriesQb($category);

        $query = $this->getEntityManager()->createQuery($qb->getDQL());
        $query->setParameter('parents', $category)
            ->setParameter('lvl', $level)
        ;

        $iterateResult = $query->iterate();

        return $iterateResult;
    }

    public function getCategoryParents($category)
    {
        $ids = array_filter(explode(',', $category->getPath()));

        $query = $this->getAvailableCategoriesQb()
            ->where('c.id IN (:path)')
            ->setParameter('path', $ids)
        ;

        return $query->getQuery()->getResult();
    }
}
